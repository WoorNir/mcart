<? namespace Bitrix\Main\Security\W;$GLOBALS['____2071137319']= array(base64_decode('dGl'.'t'.'Z'.'Q=='),base64_decode('dGl'.'tZQ=='),base64_decode('anNvbl9kZWNvZGU='),base64_decode('YXJ'.'yYX'.'lf'.'bWV'.'yZ2'.'U='),base64_decode(''.'am'.'9'.'pbg='.'='),base64_decode('am9pbg=='),base64_decode('am'.'9pbg=='),base64_decode(''.'Y'.'XJ'.'yYX'.'lfcG9w'),base64_decode('YX'.'JyYXlfc2hpZ'.'nQ='),base64_decode(''.'Y'.'XJyYXl'.'fc2'.'hp'.'Z'.'nQ='),base64_decode('YX'.'Jy'.'YXlfc'.'2h'.'pZn'.'Q='),base64_decode('YX'.'J'.'yYXlfc2h'.'pZnQ='),base64_decode('YXJyYXl'.'fb'.'WVyZ2U='),base64_decode(''.'a'.'XNf'.'YXJy'.'YXk='),base64_decode('YXJyYX'.'lfbWVyZ'.'2U='),base64_decode('aW5fYXJ'.'yY'.'Xk'.'='),base64_decode(''.'a'.'W5'.'f'.'Y'.'XJyYX'.'k='),base64_decode('aW5fYXJyYX'.'k='),base64_decode('aW5fYXJyYXk='),base64_decode('aW5f'.'YXJyYX'.'k'.'='),base64_decode(''.'dGltZQ'.'=='),base64_decode('dGl'.'tZQ=='),base64_decode('YXJ'.'yYXlfbWFw'),base64_decode('Z2V0'.'X2x'.'vYWRlZF9l'.'eH'.'RlbnNpb25'.'z'),base64_decode('anNvbl9lbmNvZGU='),base64_decode(''.'a'.'nNvbl9lbm'.'NvZGU'.'='),base64_decode(''.'cG'.'h'.'wdmV'.'yc2l'.'vbg=='),base64_decode('anNvbl9lb'.'m'.'N'.'vZ'.'GU'.'='),base64_decode('am9pbg=='));if(!function_exists(__NAMESPACE__.'\\___571813052')){function ___571813052($_67058803){static $_1986682072= false; if($_1986682072 == false) $_1986682072=array('V1dBTE'.'xfTE9DS'.'w'.'==','c'.'2VjdXJpd'.'Hk=',''.'REF'.'UQQ==','eyI=','V'.'1dBTE'.'xfT'.'E9DSw==','c2V'.'jdXJpdHk=','U0VDV'.'VJJVF'.'lfV1dB'.'TExfRVhDR'.'V'.'BUS'.'U9O','R'.'k'.'FJTF9DSEVDS0'.'lO'.'R'.'w='.'=','Q2FuIG5vdCBleGVjdXR'.'lIHd3YW'.'xs'.'IHJ1bGVzOiA'.'=',''.'IF'.'R'.'yYWNlO'.'iA=','U'.'kVRVU'.'VTV'.'F9V'.'Ukk=',''.'a2V5cw'.'==','dmFsdWV'.'z',''.'U0VD'.'VVJJVF'.'lf'.'V1'.'dBTExfTU9E'.'SUZZ',''.'Lg==','U0VD'.'VVJJVFlfV1dBT'.'E'.'x'.'fVU5TRVQ=','Lg==','U'.'0VD'.'VVJJVF'.'lf'.'V1dBTEx'.'fR'.'V'.'hJVA==','Lg==','Z2xvYmFs','a2V5c'.'w==','dmFsdWVz','Z2V0','Z2'.'V0','cG9zdA'.'==','cG9zdA==','Y2'.'9va2ll',''.'Y2'.'9va2ll','cmVx'.'dWVzdA==','cmVxdWVzdA==',''.'Z'.'2xvY'.'mF'.'s','Z2xvYm'.'F'.'s','b'.'WFpbl9zZWM=','V1dBTExfQUNUVUFMSVpFX'.'1JVTEV'.'T','dg==','dm'.'Vy'.'c'.'2'.'lvb'.'g='.'=','a'.'Q==',''.'aX'.'NJbnN0YWxsZWQ=','dg==','aW5'.'p','bW'.'9'.'kdWxl'.'cw==',''.'bGljZW5zZQ==','c'.'Ghw',''.'dg='.'=','ZXh0',''.'c2'.'V'.'jdXJ'.'pdHk=','Z'.'GI=','dHlwZ'.'Q==','ZGI=',''.'dmVyc2lvb'.'g='.'=','ZGI=','d'.'Hl'.'wZQ==',''.'ZGI'.'=','d'.'H'.'lwZQ='.'=','dm'.'Vyc2lvbg==','ZGI'.'=','d'.'mVy'.'c2lvbg='.'=','Z'.'W'.'52a'.'XJ'.'vbm1lbnQ=','dm1fd'.'mV'.'yc2lvbg==','dm'.'0'.'=','dg='.'=','ZW'.'52aXJvbm1l'.'bnQ=','d'.'m'.'1fdmVyc2lvbg==','c29ja2'.'V0VGl'.'tZW91d'.'A='.'=','c3R'.'yZW'.'FtVG'.'ltZW91dA'.'==','KCc=',''.'ZGF0'.'Y'.'Q='.'=',''.'JywgJw==','bW9kd'.'Wxl','JywgJw==','bW9kdWxlX3'.'Zlcn'.'Np'.'b'.'24=','J'.'y'.'k=','LCA=','U0V'.'DVV'.'JJVFlfV1dBTExfRVhD'.'RVBU'.'SU9'.'O','bW'.'Fp'.'bg'.'==','RkF'.'JTF9SRUZ'.'SRVN'.'I'.'SU5'.'H','Q2'.'FuI'.'G5vdCB'.'yZWZyZXNoIHd3YWxsIHJ'.'1'.'bGV'.'zOiA=','IFRyYWNl'.'OiA=','Z'.'GF0YQ==','eyI'.'=',''.'LS0'.'tLS1CRUd'.'JT'.'i'.'BQV'.'UJM'.'SUMgS'.'0'.'VZLS'.'0tLS'.'0=','Ck1'.'J'.'SUJ'.'JakFOQmdrc'.'W'.'hraUc5'.'dzBCQVF'.'FRk'.'F'.'BT0NBU'.'ThB'.'TUlJQk'.'Nn'.'S0NBU'.'UV'.'BcThRRTBIam1ISlVTdFdWNm'.'4'.'wemEKUlZvTHgw'.'Mkt6Y'.'mZ'.'yYlM'.'vUDZ'.'zV2F4VHp'.'3OFNlR'.'1R0'.'YlRDT3'.'J'.'wSGk1UUY'.'2'.'T'.'1J'.'5a'.'l'.'ovW'.'Hh6L0'.'tMV'.'TFH'.'Ym'.'9mOUNaM'.'wo0'.'ejdTa'.'3FVdDY2aWJYd'.'k9GQng0Z'.'ncvQVBQ'.'Ukd'.'E'.'cX'.'R'.'t'.'MG5EM2ZnR3'.'N1M1JlUGd3MjlpOCt2bTdtdEJLSlVZbD'.'R'.'yClZwYjZzZlpFVDlLRWI'.'2VDFIRF'.'ltRXZ'.'jMW'.'h'.'xL2'.'lp'.'dXl4T'.'HJa'.'Wm'.'k1UTZVZm'.'Y'.'0'.'VUV2V'.'EkrNjhzc0ZSa1Erb3d'.'UUnkKZ'.'U'.'9JTW'.'JGa'.'E'.'0vVVRtZlZZYlRSRnkyb1VROF'.'dNemE'.'ybko'.'1'.'U2'.'FoemkxV'.'UtPM'.'W'.'pBalh'.'UUFJy'.'em'.'M3QWp1NjM'.'5ajFPMApwcHFmbTV4Z'.'1d'.'sRkFK'.'a0hR'.'VG'.'d'.'iZG'.'Q1Q'.'VdxREZ'.'Ra'.'3Q5SE'.'tr'.'WS'.'tU'.'bmZCT'.'EdWT'.'XZW'.'eVB3'.'VE'.'hO'.'V1'.'F'.'ZQX'.'c0eHBnL3dBClp3SUR'.'BUUFCC'.'i0t'.'LS0tRU5EIFB'.'VQkxJQyBLRVk'.'tLS0tLQ'.'='.'=');return base64_decode($_1986682072[$_67058803]);}}; use Bitrix\Main\Application; use Bitrix\Main\Config\Option; use Bitrix\Main\Data\Cache; use Bitrix\Main\Loader; use Bitrix\Main\ModuleManager; use Bitrix\Main\Security\PublicKeyCipher; use Bitrix\Main\SystemException; use Bitrix\Main\Web\HttpClient; use Bitrix\Main\Web\Json; use Bitrix\Main\Security\W\Rules\Rule; use Bitrix\Main\Security\W\Rules\Results\RuleAction; use Bitrix\Main\Security\W\Rules\Results\RuleResult; use Bitrix\Main\Security\W\Rules\Results\CheckResult; use Bitrix\Main\Security\W\Rules\Results\ModifyResult; use Bitrix\Main\Type\ArrayHelper; use Bitrix\Main\Security\W\Rules\RuleRecordTable; use CSecuritySystemInformation; use ReflectionExtension; class WWall{ const CACHE_RULES_TTL= 10800; private static $_480752965= 'https://wwall.bitrix.info/rules.php'; protected $_1129359764= true; public function handle(){ try{  $_1831950978= RuleRecordTable::getList([ 'cache' =>['ttl' => 3600* 24* 7]])->fetchAll(); if(empty($_1831950978)){ return;}  $_1957522519= Cache::createInstance(); $_1833140048= false; if($_1957522519->initCache(static::CACHE_RULES_TTL, 'WWALL_LOCK', 'security')){ $_248784719= $_1957522519->getVars(); if($GLOBALS['____2071137319'][0]()- $_248784719> round(0+5+5+5+5)){  $_1859752936= Application::getConnection(); $_953031767= RuleRecordTable::getTableName(); $_1859752936->truncateTable($_953031767); RuleRecordTable::cleanCache(); $_1957522519->clean(___571813052(0), ___571813052(1));}} elseif($_1957522519->startDataCache()){  $_1957522519->endDataCache($GLOBALS['____2071137319'][1]()); $_1833140048= true;} foreach($_1831950978 as $_140635321){ $_195117857= new PublicKeyCipher; $_495695339= $_195117857->decrypt($_140635321[___571813052(2)], static::__747632189()); if(!str_starts_with($_495695339, ___571813052(3))){ continue;} $_1215893259= $GLOBALS['____2071137319'][2]($_495695339, true); if(!empty($_1215893259)){ $_1187745003= Rule::make($_1215893259); $_2114349580= $this->handleRule($_1187745003); $this->applyHandlingResults($_2114349580);}}  if($_1833140048){ $_1957522519->clean(___571813052(4), ___571813052(5));}} catch(\Throwable $_212998234){ $this->logEvent( ___571813052(6), ___571813052(7), ___571813052(8). $_212998234->getMessage(). ___571813052(9). $_212998234->getTraceAsString());}}  public function handleRule(Rule $_1187745003): array{ $_2114349580=[]; if($_1187745003->matchPath($_SERVER[___571813052(10)])){  $_818735056= $this->getContextElements($_1187745003->getContext()); foreach($_818735056 as $_1159150257 => &$_1176395735){ $_2114349580= $GLOBALS['____2071137319'][3]($_2114349580, $this->recursiveContextKeyHandle($_1159150257, $_1176395735,[], $_1187745003));}} return $_2114349580;}  public function applyHandlingResults(array $_2114349580){ $_818735056= $this->getContextElements([ 'get', 'post', 'cookie', 'request', 'global']); foreach($_2114349580 as $_2049287677){ $_1176395735=& $_818735056[$_2049287677->getContextName()]; $_1563281461= $_2049287677->getRuleResult(); $_1187745003= $_2049287677->getRule(); if($_1563281461 instanceof ModifyResult){ if($_1187745003->getProcess() === ___571813052(11)){  static::rewriteContextKey( $_2049287677->getContextName(), $_1176395735, $_2049287677->getContextKey(), $_1563281461->getCleanValue());} elseif($_1187745003->getProcess() === ___571813052(12)){ static::rewriteContextValue( $_2049287677->getContextName(), $_1176395735, $_2049287677->getContextKey(), $_1563281461->getCleanValue());} $this->logEvent( ___571813052(13), $_2049287677->getContextName(), $GLOBALS['____2071137319'][4](___571813052(14), $_2049287677->getContextKey()));} elseif($_1563281461 instanceof CheckResult &&!$_1563281461->isSuccess()){ if($_1563281461->getAction() === RuleAction::UNSET){ static::unsetContextValue( $_2049287677->getContextName(), $_1176395735, $_2049287677->getContextKey(),); $this->logEvent( ___571813052(15), $_2049287677->getContextName(), $GLOBALS['____2071137319'][5](___571813052(16), $_2049287677->getContextKey()));} elseif($_1563281461->getAction() === RuleAction::EXIT){ $this->logEvent( ___571813052(17), $_2049287677->getContextName(), $GLOBALS['____2071137319'][6](___571813052(18), $_2049287677->getContextKey())); exit;}}}} public function disableEventLogging(){ $this->_1129359764= false;} protected function rewriteContextKey($_1159150257, &$_1176395735, $_1714162512, $_1811480157){ $_962252058= $_1714162512;  $GLOBALS['____2071137319'][7]($_962252058); $_962252058[]= $_1811480157; if($_1159150257 === ___571813052(19)){ $_121303102= $GLOBALS['____2071137319'][8]($_1714162512); $GLOBALS['____2071137319'][9]($_962252058); if(empty($_1714162512)){ $GLOBALS[$_1811480157]= $GLOBALS[$_121303102]; unset($GLOBALS[$_121303102]);} else{ $_1176395735=& $GLOBALS[$_121303102]; $_61315902= ArrayHelper::getByNestedKey($_1176395735, $_1714162512);  ArrayHelper::setByNestedKey($_1176395735, $_962252058, $_61315902);  ArrayHelper::unsetByNestedKey($_1176395735, $_1714162512);}} else{ $_61315902= ArrayHelper::getByNestedKey($_1176395735, $_1714162512);  ArrayHelper::setByNestedKey($_1176395735, $_962252058, $_61315902);  ArrayHelper::unsetByNestedKey($_1176395735, $_1714162512);}} protected function rewriteContextValue($_1159150257, &$_1176395735, $_368799852, $_61315902){ if($_1159150257 === 'global'){ $_121303102= $GLOBALS['____2071137319'][10]($_368799852); if(empty($_368799852)){ $GLOBALS[$_121303102]= $_61315902;} else{ $_1176395735=& $GLOBALS[$_121303102]; ArrayHelper::setByNestedKey($_1176395735, $_368799852, $_61315902);}} else{  ArrayHelper::setByNestedKey($_1176395735, $_368799852, $_61315902);}} protected function unsetContextValue($_1159150257, &$_1176395735, $_368799852){ if($_1159150257 === 'global'){ $_121303102= $GLOBALS['____2071137319'][11]($_368799852); if(empty($_368799852)){ unset($GLOBALS[$_121303102]);} else{ $_1176395735=& $GLOBALS[$_121303102]; ArrayHelper::unsetByNestedKey($_1176395735, $_368799852);}} else{ ArrayHelper::unsetByNestedKey($_1176395735, $_368799852);}}  protected function recursiveContextKeyHandle(string $_1159150257, array &$_1176395735, array $_320648622, Rule $_1187745003): array{  $_2114349580=[]; foreach($_1176395735 as $_403219360 => $_61315902){ $_368799852= $GLOBALS['____2071137319'][12]($_320648622,[$_403219360]); if($_1187745003->matchKey($_368799852)){  if($_1187745003->getProcess() === ___571813052(20)){ $_1563281461= $_1187745003->evaluate($_403219360);} elseif($_1187745003->getProcess() === ___571813052(21)){ $_1563281461= $_1187745003->evaluateValue($_61315902);}  if(!empty($_1563281461) && $_1563281461 instanceof RuleResult){ $_2114349580[]= new HandlingResult($_1159150257, $_368799852, $_1563281461, $_1187745003);}}  if($GLOBALS['____2071137319'][13]($_61315902)){ $_2114349580= $GLOBALS['____2071137319'][14]($_2114349580, $this->recursiveContextKeyHandle( $_1159150257, $_1176395735[$_403219360], $_368799852, $_1187745003));}} return $_2114349580;} protected function getContextElements(array $_1962324294){ $_664146944=[]; if($GLOBALS['____2071137319'][15](___571813052(22), $_1962324294, true)){ $_664146944[___571813052(23)]= &$_GET;} if($GLOBALS['____2071137319'][16](___571813052(24), $_1962324294, true)){ $_664146944[___571813052(25)]= &$_POST;} if($GLOBALS['____2071137319'][17](___571813052(26), $_1962324294, true)){ $_664146944[___571813052(27)]= &$_COOKIE;} if($GLOBALS['____2071137319'][18](___571813052(28), $_1962324294, true)){ $_664146944[___571813052(29)]= &$_REQUEST;} if($GLOBALS['____2071137319'][19](___571813052(30), $_1962324294, true)){ $_664146944[___571813052(31)]= $GLOBALS;} return $_664146944;} public static function refreshRules(){ try{ $_2074494943= Option::get('main_sec', 'WWALL_ACTUALIZE_RULES', 0); if(($GLOBALS['____2071137319'][20]()- $_2074494943)< static::CACHE_RULES_TTL){ return;} Option::set(___571813052(32), ___571813052(33), $GLOBALS['____2071137319'][21]()); $_1245660276= null;  $_1468875980= $GLOBALS['____2071137319'][22](function($_1067603331){ return[___571813052(34) => $_1067603331[___571813052(35)], ___571813052(36) => (int) $_1067603331[___571813052(37)]];}, ModuleManager::getModulesFromDisk());  $_295418770=[]; foreach($GLOBALS['____2071137319'][23]() as $_1321559441){ $_1024090099= new ReflectionExtension($_1321559441); $_295418770[$_1321559441]=[ ___571813052(38) => $_1024090099->getVersion(), ___571813052(39) => $_1024090099->getINIEntries()];} $_758977386=[ ___571813052(40) => $GLOBALS['____2071137319'][24]($_1468875980), ___571813052(41) => Application::getInstance()->getLicense()->getHashLicenseKey(), ___571813052(42) => $GLOBALS['____2071137319'][25]([ ___571813052(43) => $GLOBALS['____2071137319'][26](), ___571813052(44) => $_295418770])]; if(Loader::includeModule(___571813052(45))){ $_41841887= CSecuritySystemInformation::getSystemInformation(); if(isset($_41841887[___571813052(46)][___571813052(47)]) && isset($_41841887[___571813052(48)][___571813052(49)])){ $_758977386[___571813052(50)]=[ ___571813052(51) => $_41841887[___571813052(52)][___571813052(53)], ___571813052(54) => $_41841887[___571813052(55)][___571813052(56)]];} if(isset($_41841887[___571813052(57)][___571813052(58)])){ $_758977386[___571813052(59)]=[___571813052(60) => $_41841887[___571813052(61)][___571813052(62)]];}}  $_403574103= new HttpClient([ ___571813052(63) => round(0+1.6666666666667+1.6666666666667+1.6666666666667), ___571813052(64) => round(0+1.6666666666667+1.6666666666667+1.6666666666667)]); $_848267411= $_403574103->post( static::$_480752965, $_758977386); if($_403574103->getStatus() == round(0+200) &&!empty($_848267411)){ $_1245660276= Json::decode($_848267411);}  if($_1245660276 !== null){ $_1859752936= Application::getConnection(); $_953031767= RuleRecordTable::getTableName(); if(!empty($_1245660276)){ foreach($_1245660276 as $_728236577){ if(!static::checkRuleSign($_728236577)){ throw new SystemException('Invalid sign for rule '.$GLOBALS['____2071137319'][27]($_728236577));}}}  $_1859752936->truncateTable($_953031767);  if(!empty($_1245660276)){ $_1272291065=[]; foreach($_1245660276 as $_728236577){ $_1272291065[]= ___571813052(65). $_1859752936->getSqlHelper()->forSql($_728236577[___571813052(66)]). ___571813052(67). $_1859752936->getSqlHelper()->forSql($_728236577[___571813052(68)]). ___571813052(69). $_1859752936->getSqlHelper()->forSql($_728236577[___571813052(70)]). ___571813052(71);} $_2093818199= $GLOBALS['____2071137319'][28](___571813052(72), $_1272291065);  $_1859752936->query("INSERT INTO {$_953031767} (DATA, MODULE, MODULE_VERSION) VALUES {$_2093818199}");  RuleRecordTable::cleanCache();}}} catch(\Throwable $_212998234){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, ___571813052(73), ___571813052(74), ___571813052(75), ___571813052(76). $_212998234->getMessage(). ___571813052(77). $_212998234->getTraceAsString());}} protected static function checkRuleSign($_1187745003){ $_195117857= new PublicKeyCipher; $_1215893259= $_195117857->decrypt($_1187745003[___571813052(78)], static::__747632189()); return str_starts_with($_1215893259, ___571813052(79));} private static function __747632189(){ $_504726426= ''; $_504726426 .= ___571813052(80); $_504726426 .= ___571813052(81); return $_504726426;} protected function logEvent($_393387095, $_868205894, $_893101980){ if($this->_1129359764){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, $_393387095, 'main', $_868205894, $_893101980);}}}?>